# encoding: utf-8
require 'nokogiri'

module Spider
  class HcyxbookParser < Parser
    CATEGORY_MAP = [
 ["全国卫生专业技术资格考试-纸质版", "图书音像-教育-教材"],
 ["全国卫生专业技术资格考试-电子版", "图书音像-教育-教材"],
 ["执业考试-中医师", "图书音像-教育-教材"],
 ["执业考试-临床医师", "图书音像-教育-教材"],
 ["执业考试-口腔医师", "图书音像-教育-教材"],
 ["执业考试-公卫医师", "图书音像-教育-教材"],
 ["执业考试-执业药师", "图书音像-教育-教材"],
 ["执业考试-中西医结", "图书音像-教育-教材"],
 ["医学书籍-妇儿科", "图书音像-科技-医学"],
 ["医学书籍-音像制品", "图书音像-科技-医学"],
 ["医学书籍-外科", "图书音像-科技-医学"],
 ["医学书籍-骨科", "图书音像-科技-医学"],
 ["医学书籍-皮肤科", "图书音像-科技-医学"],
 ["医学书籍-肿瘤科", "图书音像-科技-医学"],
 ["医学书籍-麻醉科", "图书音像-科技-医学"],
 ["医学书籍-神经精神", "图书音像-科技-医学"],
 ["医学书籍-影像技术", "图书音像-科技-医学"],
 ["医学书籍-护理", "图书音像-科技-医学"],
 ["医学书籍-检验", "图书音像-科技-医学"],
 ["医学书籍-药物", "图书音像-科技-医学"],
 ["医学书籍-综合类", "图书音像-科技-医学"],
 ["医学书籍-外文", "图书音像-科技-医学"],
 ["医学书籍-教辅", "图书音像-科技-医学"],
 ["医学书籍-中西医结", "图书音像-科技-医学"],
 ["医学书籍-医疗保健", "图书音像-科技-医学"],
 ["医学书籍-职称英语", "图书音像-科技-医学"],
 ["医学书籍-解剖", "图书音像-科技-医学"],
 ["医学书籍-图表类", "图书音像-科技-医学"],
 ["五官科-口腔科", "图书音像-科技-医学"],
 ["五官科-眼科", "图书音像-科技-医学"],
 ["五官科-耳鼻咽喉", "图书音像-科技-医学"],
 ["五官科-其它", "图书音像-科技-医学"],
 ["内科-心血管内", "图书音像-科技-医学"],
 ["内科-消化内科", "图书音像-科技-医学"],
 ["内科-呼吸内科", "图书音像-科技-医学"],
 ["内科-肾内科", "图书音像-科技-医学"],
 ["内科-急重症医", "图书音像-科技-医学"],
 ["内科-糖尿病", "图书音像-科技-医学"],
 ["内科-风湿病学", "图书音像-科技-医学"],
 ["内科-内分泌与", "图书音像-科技-医学"],
 ["内科-普通内科", "图书音像-科技-医学"],
 ["内科-心脏与肝", "图书音像-科技-医学"],
 ["内科-胃肠与肛", "图书音像-科技-医学"],
 ["内科-血液病学", "图书音像-科技-医学"],
 ["内科-泌尿内科", "图书音像-科技-医学"],
 ["内科-临床内科", "图书音像-科技-医学"],
 ["医学教材-研究生教", "图书音像-教育-教材"],
 ["医学教材-八年制教", "图书音像-教育-教材"],
 ["医学教材-七年制教", "图书音像-教育-教材"],
 ["医学教材-五年制教", "图书音像-教育-教材"],
 ["医学教材-中医专业", "图书音像-教育-教材"],
 ["医学教材-高职高专", "图书音像-教育-教材"],
 ["医学教材-乡村医学", "图书音像-教育-教材"],
 ["医学教材-卫生部培", "图书音像-教育-教材"],
 ["医学教材-中等卫生", "图书音像-教育-教材"],
 ["医学教材-本科教材", "图书音像-教育-教材"],
 ["医学教材-成人高考", "图书音像-教育-教材"],
 ["医学教材-自学考教", "图书音像-教育-教材"],
 ["医学教材-高等教材", "图书音像-教育-教材"],
 ["医学教材-医疗卫生", "图书音像-教育-教材"],
 ["医学教材-其它", "图书音像-教育-教材"],
 ["中医中药-中医药", "图书音像-科技-医学"],
 ["中医中药-名家丛书", "图书音像-科技-医学"],
 ["中医中药-伤寒内经", "图书音像-科技-医学"],
 ["中医中药-针灸推拿", "图书音像-科技-医学"],
 ["中医中药-方剂科", "图书音像-科技-医学"],
 ["中医中药-中医临床", "图书音像-科技-医学"],
 ["中医中药-中医古籍", "图书音像-科技-医学"],
 ["中医中药-疑难杂病", "图书音像-科技-医学"],
 ["中医中药-中医系列", "图书音像-科技-医学"],
 ["中医中药-其他", "图书音像-科技-医学"],
 ["医学模型-内科医学", "图书音像-科技-医学"],
 ["医学模型-外科医学", "图书音像-科技-医学"],
 ["医学模型-中医学医", "图书音像-科技-医学"],
 ["医学模型-临床医学", "图书音像-科技-医学"],
 ["医学模型-基础/预", "图书音像-科技-医学"],
 ["医学模型-其他医学", "图书音像-科技-医学"],
 ["博大考神-职称计算", "图书音像-教育-考试"],
 ["博大考神-职称英语", "图书音像-教育-考试"],
 ["博大考神-公务员考", "图书音像-教育-考试"],
 ["博大考神-博大致睿", "图书音像-教育-考试"],
 ["博大考神-博大致睿", "图书音像-教育-考试"],
 ["博大考神-博大致睿", "图书音像-教育-考试"],
 ["医药类试题库辅导系列软件", "图书音像-教育-考试"],
 ["公务员考试", "图书音像-教育-考试"]
    ]
    BASE_URL = "http://www.hcyxbook.com"
	def belongs_to_categories
	  categories = doc.css("td[width='70%'][valign='top']").css("a")[1,2].map do |elem|
	  {:name => elem.inner_text, :url => File.join(BASE_URL, elem["href"])}
          end
	end
    
    def title
	  doc.css("td span.title").text.strip
	end
    

	def price
      doc.css("font[color='#FF0000']").select{|price| price.text.include?("元")}.first.text[/[\d|\.]+$/].to_f 
	end

	def stock
	  1
	end

	def image_url
      img = doc.css("img[alt='点击查看图片实际尺寸']")
	  img.present? ? "http://www.hcyxbook.com/"+img.first["src"] : ""
	end

	def desc
	 # doc.css(".goods_detail").inner_html
	end

	def price_url

	end

	def score
	  doc.css("img[alt='评论星级']").first["src"][/\d+/, 0].to_i
	end

	def product_code
	  "" 
	end

	def standard
	
	end

	def get_union_url
         product.url+"?MBID=findbest360"
	end

	def comments
	 
	end

	def end_product
      route_str = product.page.category.ancestors_and_self.map do |cate|
        cate.name
      end.join("-")
      origin_base_map(CATEGORY_MAP,route_str)
	end

	def merchant
          get_merchant("汇成医学书店")
        end

	def brand
	  #doc.css("p.para_1").first.inner_text.split("：")[1]
	end

	def brand_type
	end

    def get_order_num
      route_str = product.page.category.ancestors_and_self.map do |cate|
        cate.name
      end.join("-")

      order_num_end_product = origin_base_map(CATEGORY_MAP,route_str)

      if order_num_end_product.nil?
        10000000
      else
        order_num_end_product.order_num
      end
    end

  end
end

